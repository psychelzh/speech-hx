---
title: "Analysis Notes"
author: "Liang Zhang"
date: "2021/11/14"
output:
  html_document:
    code_folding: show
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = fs::path(here::here(), "output"),
      ...
    )
  })
---

```{r setup, class.source="fold-hide"}
library(targets)
knitr::opts_knit$set(root.dir = here::here())
knitr::opts_chunk$set(echo = TRUE)
tar_unscript()
```

```{targets tar-options, tar_globals=TRUE}
future::plan(future::multisession, workers = 8)
tar_option_set(packages = "tidyverse")
```

```{targets load-data}
list(
  tarchetypes::tar_files_input(
    inputs,
    fs::dir_ls("data", recurse = TRUE, type = "file")
  ),
  tar_target(
    data,
    readxl::read_excel(inputs) |>
      add_column(
        path = inputs |>
          fs::path_file() |>
          fs::path_ext_remove()
      ) |>
      separate(path, c("format", "time"), sep = 1, convert = TRUE),
    pattern = map(inputs)
  )
)
```

```{targets distances, tar_simple=TRUE}
data |>
    group_by(format, SID, time) |>
    group_modify(
      ~ .x |>
        select(`T长度`:`type短语结构类型`) |>
        t() |>
        vegan::vegdist("chisq", na.rm = TRUE) |>
        broom::tidy()
    ) |>
    ungroup()
```
